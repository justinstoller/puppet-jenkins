#!/bin/sh
#
# /etc/init.d/jenkins-slave
# init script for Jenkins Slave Swarm Client.
#
# chkconfig: 2345 90 60
# description: Jenkins Slave Swarm Client
#
RETVAL=0

. /etc/init.d/functions

PID_FILE=/var/run/jenkins-slave.pid
LOCK_FILE=/var/lock/jenkins-slave

slave_start() {
  echo Starting Jenkins Slave...
  nohup java -jar <%= slave_home -%>/<%= client_jar -%> <%= ui_user_flag -%> <%= ui_pass_flag -%> -name <%= fqdn -%> -executors <%= executors -%> <%= masterurl_flag -%> <%= labels_flag -%>  > $LOG_FILE 2>/dev/null &
  pgrep -f -u <%= slave_user -%> <%= client_jar -%> > $PID_FILE
  RETVAL=$?
  [ $RETVAL -eq 0 ] && touch $LOCK_FILE
}
slave_stop() {
  echo Stopping Jenkins Slave...
  pid=`cat $PID_FILE`

  kill -p $pid

  RETVAL=$?
  [ $RETVAL -eq 0 ] && rm -f $LOCK_FILE
}

slave_restart() {
  echo Restarting Jenkins Slave...
  slave_stop
  slave_start

  RETVAL=$?
  [ $RETVAL -eq 0 ] && touch $LOCK_FILE
}
slave_status() {
  pid=`cat $PID_FILE`
  ps -p $pid >/dev/null 2>&1
  RETVAL=$?

  if [ $RETVAL -eq 0 ]; then
    echo Jenkins Slave is running with PID `cat $PID_FILE`
  else
    echo Jenkins Slave is STOPPED.
  fi
}
case "$1" in
  start)
    slave_start
    ;;
  stop)
    slave_stop
    ;;
  restart)
    slave_restart
    ;;
  status)
    slave_status
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status}"
    exit 1
    ;;
esac

exit $RETVAL
